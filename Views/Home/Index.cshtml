@using WebMatrix.Data
@{
    Layout = "_Layout";
    var db = Database.Open("BoardGame");

    string search = Request["search"];
    string selectedTheme = Request["theme"];
    string viewMode = Request["view"] ?? "table";

    // Theme dropdown
    var themes = db.Query("SELECT ThemeID, ThemeName FROM Theme ORDER BY ThemeName");

    // Base SQL with JOIN to get theme + family names
    string sql = @"
        SELECT BG.*, 
        T.ThemeName,
        F.Family
        FROM BoardGame BG
        LEFT JOIN GameInThemes GT ON BG.BGGId = GT.BGGId
        LEFT JOIN Theme T ON GT.ThemeID = T.ThemeID
        LEFT JOIN GameFamily F ON BG.FamilyCode = F.FamilyCode
        WHERE 1=1";

    var parameters = new List<object>();

    if (!String.IsNullOrWhiteSpace(search))
    {
        sql += " AND BG.Name LIKE @0";
        parameters.Add("%" + search + "%");
    }

    if (!String.IsNullOrWhiteSpace(selectedTheme))
    {
        sql += (parameters.Count == 0)
            ? " AND T.ThemeID = @0"
            : " AND T.ThemeID = @" + parameters.Count;
        parameters.Add(selectedTheme);
    }

    sql += " ORDER BY BG.Name";

    var games = db.Query(sql, parameters.ToArray());
}

<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Board Game Collection</h2>
        <a href="/Home/Create" class="btn btn-success">+ Add Game</a>
    </div>

    <!-- Filter Form -->
    <form method="get" class="row g-2 mb-3">
        <div class="col-md-4">
            <input type="text" name="search" value="@search" class="form-control" placeholder="Search by name..." />
        </div>
        <div class="col-md-3">
            <select name="theme" class="form-select">
                <option value="">All Themes</option>
                @foreach (var t in themes)
                {
                    <option value="@t.ThemeID" @(t.ThemeID == selectedTheme ? "selected" : "")>
                        @t.ThemeName
                    </option>
                }
            </select>
        </div>
        <div class="col-md-3">
            <select name="view" class="form-select">
                <option value="table" @(viewMode == "table" ? "selected" : "")>Table View</option>
                <option value="card" @(viewMode == "card" ? "selected" : "")>Card View</option>
            </select>
        </div>
        <div class="col-md-2">
            <button class="btn btn-primary w-100" type="submit">Filter</button>
        </div>
    </form>

    @if (!games.Any())
    {
        <div class="alert alert-warning text-center">
            No games found.
        </div>
    }
    else if (viewMode == "card")
    {
        <!-- Card View -->
        <div class="row row-cols-1 row-cols-md-3 g-4">
            @foreach (var g in games)
            {
                string img = String.IsNullOrWhiteSpace(g.ImagePath)
                    ? "/images/noimage.png" : g.ImagePath;

                string desc = String.IsNullOrEmpty(g.Description)
                    ? "No description available."
                    : g.Description.Length > 120 ? g.Description.Substring(0, 120) + "..." : g.Description;

                <div class="col">
                    <div class="card h-100 shadow-sm">
                        <img src="@img" class="card-img-top" style="height:220px; object-fit:cover;">
                        <div class="card-body">
                            <h5>@g.Name</h5>
                            <p class="text-muted small">@desc</p>
                            <p class="small">
                                <strong>Players:</strong> @g.MinPlayers-@g.MaxPlayers |
                                <strong>Year:</strong> @g.YearPublished |
                                <strong>Theme:</strong> @g.ThemeName
                            </p>
                        </div>
                        <div class="card-footer text-center bg-light">
                            <a href="/Home/Details?id=@g.BGGId" class="btn btn-outline-primary btn-sm">Details</a>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <!-- Table View -->
        <table class="table table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Image</th>
                    <th>Name</th>
                    <th>Theme</th>
                    <th>Players</th>
                    <th>Year</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var g in games)
                {
                    string img = String.IsNullOrWhiteSpace(g.ImagePath)
                        ? "/images/noimage.png" : g.ImagePath;

                    <tr>
                        <td><img src="@img" width="65" height="65" class="rounded"></td>
                        <td>@g.Name</td>
                        <td>@(g.ThemeName ?? "-")</td>
                        <td>@g.MinPlayers-@g.MaxPlayers</td>
                        <td>@g.YearPublished</td>
                        <td>
                            <a href="/Home/Details?id=@g.BGGId" class="btn btn-sm btn-info text-white">View</a>
                            <a href="/Home/Edit?id=@g.BGGId" class="btn btn-sm btn-warning">Edit</a>
                            <a href="/Home/Delete?id=@g.BGGId" class="btn btn-sm btn-danger"
                               onclick="return confirm('Delete this game?');">Delete</a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>
