@using WebMatrix.Data
@{
    Layout = "_Layout";
    var db = Database.Open("BoardGame");

    // Get user inputs
    string search = Request["search"];
    string viewMode = Request["view"] ?? "table"; // Default: table
    string selectedCategory = Request["category"];

    // Load category options
    var categories = db.Query("SELECT DISTINCT Category FROM Category ORDER BY Category");

    // Build SQL query
    string sql = "SELECT * FROM BoardGame WHERE 1=1";

    if (!String.IsNullOrEmpty(search))
    {
        sql += " AND Name LIKE @0";
    }

    if (!String.IsNullOrEmpty(selectedCategory))
    {
        sql += " AND BGGId IN (SELECT BGGId FROM GameCategory WHERE Category = @1)";
    }

    sql += " ORDER BY Name";

    var games = db.Query(sql, "%" + search + "%", selectedCategory);
}
<link rel="stylesheet" href="~/css/site.css" />


<div class="container mt-4">
    <h2 class="text-center mb-4">Board Game Collection</h2>

    <form method="get" class="row mb-3 g-2">
        <div class="col-md-4">
            <input type="text" name="search" value="@search" class="form-control" placeholder="Search by name..." />
        </div>

        <div class="col-md-3">
            <select name="category" class="form-select">
                <option value="">All Categories</option>
                @foreach (var cat in categories)
                {
                    <option value="@cat.Category" @(cat.Category == selectedCategory ? "selected" : "")>
                        @cat.Category
                    </option>
                }
            </select>
        </div>

        <div class="col-md-3">
            <select name="view" class="form-select">
                <option value="table" @(viewMode == "table" ? "selected" : "")>Table View</option>
                <option value="card" @(viewMode == "card" ? "selected" : "")>Card View</option>
            </select>
        </div>

        <div class="col-md-2 text-end">
            <button class="btn btn-primary w-100" type="submit">Apply</button>
        </div>
    </form>

    @if (viewMode == "table")
    {
        <!-- Table Layout -->
        <table class="table table-striped table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Image</th>
                    <th>Name</th>
                    <th>Year</th>
                    <th>Players</th>
                    <th>Playtime</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var g in games)
                {
                    <tr>
                        <td>
                            <img src="@g.ImagePath" width="80" height="80" class="rounded shadow-sm" />
                        </td>
                        <td>@g.Name</td>
                        <td>@g.YearPublished?.ToString("yyyy")</td>
                        <td>@g.MinPlayers - @g.MaxPlayers</td>
                        <td>@g.MfgPlaytime mins</td>
                        <td>
                            <a href="/Home/Details?id=@g.BGGId" class="btn btn-sm btn-outline-primary">Details</a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <!-- Card Layout -->
        <div class="row row-cols-1 row-cols-md-3 g-4">
            @foreach (var g in games)
            {
                <div class="col">
                    <div class="card shadow-sm h-100">
                        <img src="@g.ImagePath" class="card-img-top" alt="@g.Name" style="height:220px; object-fit:cover;">
                        <div class="card-body">
                            <h5 class="card-title">@g.Name</h5>
                            <p class="card-text text-muted">@g.Description.Substring(0, Math.Min(120, g.Description.Length))...</p>
                            <ul class="list-unstyled small">
                                <li><strong>Players:</strong> @g.MinPlayers - @g.MaxPlayers</li>
                                <li><strong>Year:</strong> @g.YearPublished?.ToString("yyyy")</li>
                                <li><strong>Playtime:</strong> @g.MfgPlaytime mins</li>
                            </ul>
                        </div>
                        <div class="card-footer text-center bg-light">
                            <a href="/Home/Details?id=@g.BGGId" class="btn btn-outline-primary btn-sm">Details</a>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>
