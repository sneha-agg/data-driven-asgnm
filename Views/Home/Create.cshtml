@using WebMatrix.Data
@{
    Layout = "_Layout";
    var db = Database.Open("BoardGame");

    var families = db.Query("SELECT FamilyCode, Family FROM GameFamily ORDER BY Family");
    var themes = db.Query("SELECT ThemeID, ThemeName FROM Theme ORDER BY ThemeName");

    string message = "";
    bool success = false;

    if (IsPost)
    {
        string name = Request["Name"];
        string description = Request["Description"];
        int year = Convert.ToInt32(Request["Year"]);
        int minPlayers = Convert.ToInt32(Request["MinPlayers"]);
        int maxPlayers = Convert.ToInt32(Request["MaxPlayers"]);
        int playtime = Convert.ToInt32(Request["Playtime"]);
        string familyCode = String.IsNullOrEmpty(Request["FamilyCode"]) ? null : Request["FamilyCode"];
        string themeId = Request["ThemeID"];
        string newTheme = Request["NewTheme"];
        string imagePath = Request["ImagePath"];

        // Create new theme if typed
        if (!String.IsNullOrWhiteSpace(newTheme))
        {
            var existingTheme = db.QueryValue(
                "SELECT ThemeID FROM Theme WHERE ThemeName = @0", newTheme);

            if (existingTheme == null)
            {
                themeId = Guid.NewGuid().ToString().Substring(0, 6);
                db.Execute("INSERT INTO Theme (ThemeID, ThemeName) VALUES (@0, @1)",
                    themeId, newTheme);
            }
            else
            {
                themeId = existingTheme;
            }
        }

        try
        {
            // Insert new game and get new ID correctly
            int newGameId = (int)db.QueryValue(@"
                INSERT INTO BoardGame
                (Name, Description, YearPublished, MinPlayers, MaxPlayers, MfgPlaytime, FamilyCode, ImagePath)
                OUTPUT INSERTED.BGGId
                VALUES (@0, @1, @2, @3, @4, @5, @6, @7)",
                name, description, year, minPlayers, maxPlayers,
                playtime, familyCode, imagePath);

            // Link theme
            if (!String.IsNullOrEmpty(themeId))
            {
                db.Execute("INSERT INTO GameInThemes (BGGId, ThemeID) VALUES (@0, @1)",
                    newGameId, themeId);
            }

            success = true;
            message = "ðŸŽ‰ Game added successfully!";
        }
        catch (Exception ex)
        {
            message = "âš  Failed to add game: " + ex.Message;
        }
    }
}

<div class="container mt-5">
    <div class="card shadow rounded-3">
        <div class="card-body p-4">
            <h2 class="text-center mb-4">ðŸ†• Add New Board Game</h2>

            @if (!String.IsNullOrEmpty(message))
            {
                <div class="alert @(success ? "alert-success" : "alert-danger")">@message</div>
            }

            @if (!success)
            {
                <form method="post" class="needs-validation" novalidate>
                    <div class="row g-3">

                        <div class="col-md-6">
                            <label class="form-label">Game Name *</label>
                            <input type="text" name="Name" class="form-control" required>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">Year Published *</label>
                            <input type="number" name="Year" min="1900" max="2100" class="form-control" required>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">Playtime (mins)</label>
                            <input type="number" name="Playtime" min="1" class="form-control">
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">Min Players *</label>
                            <input type="number" name="MinPlayers" min="1" class="form-control" required>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">Max Players *</label>
                            <input type="number" name="MaxPlayers" min="1" class="form-control" required>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Game Family</label>
                            <select name="FamilyCode" class="form-select">
                                <option value="">-- Select Family --</option>
                                @foreach (var f in families)
                                {
                                    <option value="@f.FamilyCode">@f.Family</option>
                                }
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Select Theme</label>
                            <select name="ThemeID" class="form-select">
                                <option value="">-- Select Theme --</option>
                                @foreach (var t in themes)
                                {
                                    <option value="@t.ThemeID">@t.ThemeName</option>
                                }
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Or Add New Theme</label>
                            <input type="text" name="NewTheme" required class="form-control">
                        </div>

                        <div class="col-md-12">
                            <label class="form-label">Description *</label>
                            <textarea name="Description" rows="4" class="form-control" required></textarea>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Image Path (URL)</label>
                            <input type="text" required name="ImagePath" class="form-control">
                        </div>

                    </div>

                    <div class="mt-4 text-center">
                        <button type="submit" class="btn btn-success px-4"> Add Game</button>
                        <a href="/Home/Index" class="btn btn-outline-secondary ms-2">Cancel</a>
                    </div>
                </form>
            }
        </div>
    </div>
</div>

<script>
(() => {
    const forms = document.querySelectorAll('.needs-validation')
    Array.from(forms).forEach(form => {
        form.addEventListener('submit', e => {
            if (!form.checkValidity()) {
                e.preventDefault()
                e.stopPropagation()
            }
            form.classList.add('was-validated')
        }, false)
    })
})()
</script>
